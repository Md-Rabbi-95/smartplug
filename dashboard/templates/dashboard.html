<!DOCTYPE html>
<html>
<head>
    <title>Smart Plug Monitoring Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    :root {
        --primary-bg: #f0f4f8;
        --card-bg: #ffffff;
        --text-color: #222;
        --accent: #2b90d9;
        --accent-light: #d3ecfa;
    }

    body.dark-mode {
        --primary-bg: #0e141b;
        --card-bg: #1a252f;
        --text-color: #e0e0e0;
        --accent: #4cc9f0;
        --accent-light: #0e1c29;
    }

    body {
        background: var(--primary-bg);
        color: var(--text-color);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        transition: background 0.4s, color 0.4s;
    }

    h1 {
        color: var(--accent);
        font-weight: 700;
        transition: color 0.4s;
    }

    body.dark-mode h1 {
        color: var(--accent);
    }

    .card {
        border-radius: 20px;
        background: var(--card-bg);
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: background 0.4s, transform 0.3s;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .card-body h2 {
        font-weight: 700;
        font-size: 2rem;
    }

    .card-body p {
        font-size: 1rem;
        margin-top: 0.5rem;
    }

    #toggle-btn {
        border-radius: 30px;
        padding: 12px 32px;
        font-size: 1.25rem;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: background 0.3s, transform 0.2s;
    }

    #toggle-btn:active {
        transform: scale(0.95);
    }

    canvas {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 15px;
        transition: background 0.4s;
    }

    #dark-mode-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 999;
        border-radius: 50%;
        width: 55px;
        height: 55px;
        font-size: 1.6rem;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .shadow {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1) !important;
    }
</style>

</head>
<body class="p-4">

<!-- Dark Mode Toggle -->
<button id="dark-mode-btn" class="btn btn-secondary">üåô</button>

<div class="container">
    <h1 class="text-center mb-4">Smart Plug Energy Monitor</h1>

    <!-- Summary Cards -->
    <div id="summary-section">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card text-center shadow">
                    <div class="card-body bg-info text-white rounded">
                        <h2 id="today-kwh">{{ energy_today|floatformat:2 }}</h2>
                        <p>Today (kWh)</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-center shadow">
                    <div class="card-body bg-primary text-white rounded">
                        <h2 id="monthly-cost">{{ monthly_cost|floatformat:2 }}</h2>
                        <p>Monthly Cost (‡ß≥)</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-center shadow">
                    <div class="card-body bg-warning text-dark rounded">
                        <h2 id="current">{{ current|floatformat:2 }}</h2>
                        <p>Current (A)</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-center shadow">
                    <div class="card-body bg-danger text-white rounded">
                        <h2 id="power">{{ power|floatformat:2 }}</h2>
                        <p>Power (W)</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-center shadow">
                    <div class="card-body bg-success text-white rounded">
                        <h2 id="voltage">{{ voltage|floatformat:2 }}</h2>
                        <p>Voltage (V)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toggle Button -->
    <div class="text-center mt-4">
        <form id="toggle-form">
            {% csrf_token %}
            <button class="btn {% if on_off %}btn-danger{% else %}btn-primary{% endif %} btn-lg" id="toggle-btn">
                {% if on_off %}Turn OFF{% else %}Turn ON{% endif %}
            </button>
        </form>
        <p class="mt-2" id="status-text">
            {% if on_off %}
                <span class="text-success fw-bold">Device is ON</span>
            {% else %}
                <span class="text-danger fw-bold">Device is OFF</span>
            {% endif %}
        </p>
    </div>

    <!-- Power Graph -->
    <div class="card mt-4 shadow">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h4 class="text-center mb-3">Real-Time Power Graph</h4>
                    <canvas id="powerChart" height="100"></canvas>
                </div>
                <div class="col-md-6">
                    <h4 class="text-center mb-3">Average Power Usage by Hour (Today)</h4>
                    <canvas id="powerChartToday" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- CSV Download Button -->
    <div class="text-center mt-4">
    <a href="/api/download-csv/" class="btn btn-success btn-lg shadow">
    ‚¨áÔ∏è Download CSV
  </a>
  </div>
</div>
<script>

const ctx = document.getElementById('powerChart').getContext('2d');
const ctx2 = document.getElementById('powerChartToday').getContext('2d');

const chartRealTime = new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ timestamps|safe }},
        datasets: [{
            label: 'Power (W)',
            data: {{ powers|safe }},
            borderColor: '#d80b0bff',
            backgroundColor: 'rgba(0, 0, 0, 0.2)',
            fill: true,
            tension: 0.3,
            pointBackgroundColor: '#000000ff'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: false }
        }
    }
});

const chartToday = new Chart(ctx2, {
    type: 'bar',
    data: {
        labels: {{ hours|safe }},
        datasets: [{
            label: 'Power (W)',
            data: {{ powers_today|safe }},
            borderColor: '#5f0606ff',
            backgroundColor: 'rgba(58, 5, 204, 0.2)',
            fill: true,
            tension: 0.3,
            pointBackgroundColor: '#000000ff'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: false }
        }
    }
});

// Refresh data every 1 second
async function refreshData() {
    const response = await fetch('/api/power-data/');
    const data = await response.json();

    // Update chart
    chartRealTime.data.labels = data.timestamps;
    chartRealTime.data.datasets[0].data = data.powers;
    chartRealTime.update();

    chartToday.data.labels = data.hours;
    chartToday.data.datasets[0].data = data.powers_today;
    chartToday.update();

    // Update summary cards
    document.getElementById('today-kwh').innerText = data.energy_today.toFixed(2);
    document.getElementById('current').innerText = data.current.toFixed(2);
    document.getElementById('power').innerText = data.power.toFixed(2);
    document.getElementById('voltage').innerText = data.voltage.toFixed(2);


    

    // Update toggle button and status text
    const btn = document.getElementById('toggle-btn');
    const statusText = document.getElementById('status-text');
    btn.innerText = data.on_off ? "Turn OFF" : "Turn ON";
    btn.classList.toggle('btn-danger', data.on_off);
    btn.classList.toggle('btn-primary', !data.on_off);
    statusText.innerHTML = data.on_off
        ? '<span class="text-success fw-bold">Device is ON</span>'
        : '<span class="text-danger fw-bold">Device is OFF</span>';
}

setInterval(refreshData, 1000);

// Toggle button function - FIXED
document.getElementById('toggle-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Determine current state dynamically from button class
    const btn = document.getElementById('toggle-btn');
    const isOn = btn.classList.contains('btn-danger'); // btn-danger means ON currently
    const url = isOn ? '/api/turn-off/' : '/api/turn-on/';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        await response.json();
        // refreshData(); // refresh UI instantly
    } catch (error) {
        console.error('Error:', error);
    }
});

// Dark mode toggle
const darkModeBtn = document.getElementById('dark-mode-btn');
darkModeBtn.addEventListener('click', function () {
    document.body.classList.toggle('dark-mode');
    darkModeBtn.innerText = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
});

</script>
</body>
</html>